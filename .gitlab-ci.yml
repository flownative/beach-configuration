stages:
  - test

variables:
  PROJECT_NAME: 'beach-configuration'

test:
  stage: test
  image: registry.gitlab.com/flownative/docker/composer:7.2
  artifacts:
    paths:
      - '*'
    name: ${PROJECT_NAME}-${CI_COMMIT_SHA}
    when: on_success
    expire_in: 1 day
  script:
    - ls -la
    - mkdir DistributionPackages
    - 'mv * DistributionPackages/'
    - 'mv .* DistributionPackages/'
    - cp DistributionPackages/Tests/test-distribution-composer.json /composer.json
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - ssh-add <(echo "${CI_REPOSITORY_ACCESS_PRIVATE_KEY}")
    - mkdir -p ~/.ssh && ssh-keyscan -t rsa gitlab.com >> ~/.ssh/known_hosts
    - composer -o -v --no-progress --ignore-platform-reqs install
    - ls -la
    - Packages/Libraries/phpunit/phpunit/phpunit -c /Build/BuildEssentials/PhpUnit/UnitTests.xml --testdox DistributionPackages/Flownative.Beach.Configuration/Tests/Unit
